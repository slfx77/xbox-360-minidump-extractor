<?xml version="1.0" encoding="utf-8"?>

<UserControl
  x:Class="Xbox360MemoryCarver.App.SingleFileTab"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:controls="using:Microsoft.UI.Xaml.Controls"
  xmlns:local="using:Xbox360MemoryCarver.App">

  <Grid Padding="16">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <!--  TOP: File Input Section  -->
    <Border
      Grid.Row="0"
      Margin="0,0,0,8"
      Padding="12"
      Background="{ThemeResource SystemControlBackgroundChromeMediumLowBrush}"
      CornerRadius="8">
      <Grid RowSpacing="8">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <!--  Minidump Path  -->
        <TextBlock
          Grid.Row="0"
          Grid.Column="0"
          Margin="0,0,12,0"
          VerticalAlignment="Center"
          Text="Minidump Path" />
        <TextBox
          x:Name="MinidumpPathTextBox"
          Grid.Row="0"
          Grid.Column="1"
          Margin="0,0,8,0"
          IsReadOnly="True"
          PlaceholderText="Select a .dmp file..."
          TextChanged="MinidumpPathTextBox_TextChanged" />
        <Button
          Grid.Row="0"
          Grid.Column="2"
          Click="OpenMinidumpButton_Click"
          Content="Open..." />

        <!--  Output Path  -->
        <TextBlock
          Grid.Row="1"
          Grid.Column="0"
          Margin="0,0,12,0"
          VerticalAlignment="Center"
          Text="Output Path" />
        <TextBox
          x:Name="OutputPathTextBox"
          Grid.Row="1"
          Grid.Column="1"
          Margin="0,0,8,0"
          IsReadOnly="True"
          PlaceholderText="Select output directory..." />
        <Button
          Grid.Row="1"
          Grid.Column="2"
          Click="BrowseOutputButton_Click"
          Content="Browse..." />
      </Grid>
    </Border>

    <!--  Progress Bar  -->
    <ProgressBar
      x:Name="AnalysisProgressBar"
      Grid.Row="1"
      Margin="0,0,0,8"
      IsIndeterminate="True"
      Visibility="Collapsed" />

    <!--  MIDDLE: Memory Map and Discovered Files side-by-side  -->
    <Grid Grid.Row="2">
      <Grid.ColumnDefinitions>
        <ColumnDefinition
          Width="*"
          MinWidth="500" />
        <ColumnDefinition Width="8" />
        <ColumnDefinition
          Width="*"
          MinWidth="400" />
      </Grid.ColumnDefinitions>

      <!--  Memory Map (Hex Viewer)  -->
      <Border
        Grid.Column="0"
        Padding="8"
        Background="{ThemeResource SystemControlBackgroundChromeMediumLowBrush}"
        CornerRadius="8">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>

          <TextBlock
            Grid.Row="0"
            Margin="0,0,0,8"
            Style="{StaticResource SubtitleTextBlockStyle}"
            Text="Memory Map" />

          <local:HexViewerControl
            x:Name="HexViewer"
            Grid.Row="1" />
        </Grid>
      </Border>

      <!--  Splitter space  -->
      <controls:ContentPresenter Grid.Column="1" />

      <!--  Discovered Files Table  -->
      <Border
        Grid.Column="2"
        Padding="8"
        Background="{ThemeResource SystemControlBackgroundChromeMediumLowBrush}"
        CornerRadius="8">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>

          <TextBlock
            Grid.Row="0"
            Margin="0,0,0,8"
            Style="{StaticResource SubtitleTextBlockStyle}"
            Text="Discovered Files" />

          <ListView
            x:Name="ResultsListView"
            Grid.Row="1"
            SelectionChanged="ResultsListView_SelectionChanged"
            SelectionMode="Extended">
            <ListView.HeaderTemplate>
              <DataTemplate>
                <Grid
                  Padding="8,4"
                  Background="{ThemeResource SystemControlBackgroundListLowBrush}">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="100" />
                    <ColumnDefinition Width="80" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="60" />
                  </Grid.ColumnDefinitions>
                  <TextBlock
                    Grid.Column="0"
                    FontWeight="SemiBold"
                    Text="Offset" />
                  <TextBlock
                    Grid.Column="1"
                    FontWeight="SemiBold"
                    Text="Length" />
                  <TextBlock
                    Grid.Column="2"
                    FontWeight="SemiBold"
                    Text="Type" />
                  <TextBlock
                    Grid.Column="3"
                    FontWeight="SemiBold"
                    Text="Status" />
                </Grid>
              </DataTemplate>
            </ListView.HeaderTemplate>
            <ListView.ItemTemplate>
              <DataTemplate x:DataType="local:CarvedFileEntry">
                <Grid Padding="8,4">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="100" />
                    <ColumnDefinition Width="80" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="60" />
                  </Grid.ColumnDefinitions>
                  <TextBlock
                    Grid.Column="0"
                    FontFamily="Consolas"
                    Text="{x:Bind OffsetHex}" />
                  <TextBlock
                    Grid.Column="1"
                    Text="{x:Bind LengthFormatted}" />
                  <TextBlock
                    Grid.Column="2"
                    Text="{x:Bind FileType}"
                    TextTrimming="CharacterEllipsis" />
                  <FontIcon
                    Grid.Column="3"
                    HorizontalAlignment="Center"
                    Foreground="{x:Bind ExtractedColor, Mode=OneWay}"
                    Glyph="{x:Bind ExtractedGlyph, Mode=OneWay}" />
                </Grid>
              </DataTemplate>
            </ListView.ItemTemplate>
          </ListView>
        </Grid>
      </Border>
    </Grid>

    <!--  BOTTOM: File Types, Options, and Extract Button  -->
    <Border
      Grid.Row="3"
      Margin="0,8,0,0"
      Padding="12"
      Background="{ThemeResource SystemControlBackgroundChromeMediumLowBrush}"
      CornerRadius="8">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  File Type Filters  -->
        <Expander
          Grid.Row="0"
          Margin="0,0,0,8"
          HorizontalAlignment="Stretch"
          HorizontalContentAlignment="Stretch"
          Header="File Types to Extract">
          <StackPanel
            x:Name="FileTypeCheckboxPanel"
            Orientation="Horizontal"
            Spacing="16">
            <!--  Checkboxes will be generated dynamically  -->
          </StackPanel>
        </Expander>

        <!--  Options and Extract Button  -->
        <Grid Grid.Row="1">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>

          <StackPanel
            Grid.Column="0"
            VerticalAlignment="Center"
            Orientation="Horizontal"
            Spacing="16">
            <CheckBox
              x:Name="ConvertDdxCheckBox"
              Content="Convert DDX to DDS"
              IsChecked="True" />
            <CheckBox
              x:Name="SaveAtlasCheckBox"
              Content="Save Atlas Files" />
            <CheckBox
              x:Name="VerboseCheckBox"
              Content="Verbose Output" />
          </StackPanel>

          <StackPanel
            Grid.Column="1"
            Orientation="Horizontal"
            Spacing="8">
            <Button
              x:Name="AnalyzeButton"
              MinWidth="100"
              Click="AnalyzeButton_Click"
              Content="Analyze"
              IsEnabled="False"
              Style="{StaticResource AccentButtonStyle}" />
            <Button
              x:Name="ExtractButton"
              MinWidth="120"
              Click="ExtractButton_Click"
              Content="Extract Files"
              IsEnabled="False"
              Style="{StaticResource AccentButtonStyle}" />
          </StackPanel>
        </Grid>
      </Grid>
    </Border>
  </Grid>
</UserControl>
