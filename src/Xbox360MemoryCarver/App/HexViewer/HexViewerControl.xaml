<?xml version="1.0" encoding="utf-8"?>

<UserControl
  x:Class="Xbox360MemoryCarver.HexViewerControl"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:ctk="using:CommunityToolkit.WinUI.Controls">

  <Grid>
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="*" />
      <ColumnDefinition Width="120" />
    </Grid.ColumnDefinitions>

    <!--  Main Hex View  -->
    <Grid Grid.Column="0">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
      </Grid.RowDefinitions>

      <!--  Legend - populated dynamically from FileTypeColors  -->
      <Border
        Grid.Row="0"
        Margin="0,0,0,4"
        Padding="8,4"
        Background="#FF1E1E1E"
        CornerRadius="4">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>

          <ctk:WrapPanel
            x:Name="LegendPanel"
            Grid.Column="0"
            VerticalAlignment="Center"
            HorizontalSpacing="12"
            VerticalSpacing="4" />

          <!--  Search toggle button  -->
          <Button
            x:Name="SearchToggleButton"
            Grid.Column="1"
            HorizontalAlignment="Right"
            VerticalAlignment="Center"
            Background="Transparent"
            BorderThickness="0"
            Click="SearchToggleButton_Click"
            Padding="6,4"
            ToolTipService.ToolTip="Search (Ctrl+F)">
            <FontIcon
              FontSize="14"
              Foreground="#FF888888"
              Glyph="&#xE721;" />
          </Button>
        </Grid>
      </Border>

      <!--  Hex content with custom virtualization  -->
      <Border
        x:Name="HexContentBorder"
        Grid.Row="1"
        Background="#FF1E1E1E"
        BorderThickness="0"
        CornerRadius="4,4,0,0">
        <Grid>
          <!--  Custom ScrollBar for virtual scrolling  -->
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>
          <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
          </Grid.RowDefinitions>

          <!--  Hex display area with three separate columns  -->
          <Border
            x:Name="HexDisplayArea"
            Grid.Row="0"
            Grid.Column="0"
            Padding="4"
            Background="Transparent"
            BorderThickness="0"
            SizeChanged="HexDisplayArea_SizeChanged">
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>

              <!--  Offset column (not selectable)  -->
              <TextBlock
                x:Name="OffsetTextBlock"
                Grid.Column="0"
                Margin="0,0,8,0"
                VerticalAlignment="Top"
                FontFamily="Consolas"
                FontSize="12"
                Foreground="#FF569CD6"
                IsTextSelectionEnabled="False"
                TextWrapping="NoWrap" />

              <!--  Hex column (selectable with custom context menu)  -->
              <TextBlock
                x:Name="HexTextBlock"
                Grid.Column="1"
                Margin="0,0,16,0"
                VerticalAlignment="Top"
                FontFamily="Consolas"
                FontSize="12"
                IsTextSelectionEnabled="True"
                TextWrapping="NoWrap">
                <TextBlock.ContextFlyout>
                  <MenuFlyout>
                    <MenuFlyoutItem
                      x:Name="HexCopyMenuItem"
                      Click="CopyHexMenuItem_Click"
                      Text="Copy">
                      <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator
                          Key="C"
                          Modifiers="Control" />
                      </MenuFlyoutItem.KeyboardAccelerators>
                    </MenuFlyoutItem>
                  </MenuFlyout>
                </TextBlock.ContextFlyout>
              </TextBlock>

              <!--  ASCII column (selectable with custom context menu)  -->
              <TextBlock
                x:Name="AsciiTextBlock"
                Grid.Column="2"
                VerticalAlignment="Top"
                FontFamily="Consolas"
                FontSize="12"
                Foreground="#FF808080"
                IsTextSelectionEnabled="True"
                TextWrapping="NoWrap">
                <TextBlock.ContextFlyout>
                  <MenuFlyout>
                    <MenuFlyoutItem
                      x:Name="AsciiCopyMenuItem"
                      Click="CopyAsciiMenuItem_Click"
                      Text="Copy">
                      <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator
                          Key="C"
                          Modifiers="Control" />
                      </MenuFlyoutItem.KeyboardAccelerators>
                    </MenuFlyoutItem>
                  </MenuFlyout>
                </TextBlock.ContextFlyout>
              </TextBlock>
            </Grid>
          </Border>

          <!--  Virtual scrollbar - tooltip disabled  -->
          <Slider
            x:Name="VirtualScrollBar"
            Grid.Row="0"
            Grid.Column="1"
            MinWidth="20"
            Margin="4,0,0,0"
            IsDirectionReversed="True"
            IsThumbToolTipEnabled="False"
            Maximum="100"
            Minimum="0"
            Orientation="Vertical"
            SnapsTo="StepValues"
            StepFrequency="1"
            TickFrequency="0"
            ValueChanged="VirtualScrollBar_ValueChanged" />

          <!--  Search Panel (above position indicator)  -->
          <Border
            x:Name="SearchPanel"
            Grid.Row="1"
            Grid.Column="0"
            Grid.ColumnSpan="2"
            Padding="8,6"
            Background="#FF252526"
            CornerRadius="4,4,0,0"
            Visibility="Collapsed">
            <Grid>
              <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
              </Grid.RowDefinitions>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
              </Grid.ColumnDefinitions>

              <!--  Row 1, Col 0: Search box with embedded prev/next buttons  -->
              <Border
                Grid.Row="0"
                Grid.Column="0"
                Background="#FF1E1E1E"
                BorderBrush="#FF3C3C3C"
                BorderThickness="1"
                CornerRadius="4">
                <StackPanel Orientation="Horizontal">
                  <TextBox
                    x:Name="SearchTextBox"
                    Width="220"
                    MinHeight="28"
                    Padding="8,4"
                    VerticalAlignment="Center"
                    VerticalContentAlignment="Center"
                    Background="Transparent"
                    BorderThickness="0"
                    FontSize="13"
                    KeyDown="SearchTextBox_KeyDown"
                    PlaceholderText="Search..." />
                  <Border
                    Width="1"
                    Margin="0,4"
                    Background="#FF3C3C3C" />
                  <Button
                    x:Name="SearchPrevButton"
                    Width="28"
                    Height="28"
                    Padding="0"
                    Background="Transparent"
                    BorderThickness="0"
                    Click="SearchPrevButton_Click"
                    ToolTipService.ToolTip="Previous (Shift+F3)">
                    <FontIcon
                      FontSize="11"
                      Foreground="#FFAAAAAA"
                      Glyph="&#xE010;" />
                  </Button>
                  <Button
                    x:Name="SearchNextButton"
                    Width="28"
                    Height="28"
                    Padding="0"
                    Background="Transparent"
                    BorderThickness="0"
                    Click="SearchNextButton_Click"
                    ToolTipService.ToolTip="Next (F3)">
                    <FontIcon
                      FontSize="11"
                      Foreground="#FFAAAAAA"
                      Glyph="&#xE011;" />
                  </Button>
                </StackPanel>
              </Border>

              <!--  Row 1, Col 1: Search button (accent color)  -->
              <Button
                x:Name="SearchButton"
                Grid.Row="0"
                Grid.Column="1"
                Height="28"
                Margin="8,0,0,0"
                Padding="12,0"
                VerticalAlignment="Center"
                Click="SearchButton_Click"
                Content="Search"
                Style="{StaticResource AccentButtonStyle}" />

              <!--  Row 1, Col 2: Results text  -->
              <TextBlock
                x:Name="SearchResultsText"
                Grid.Row="0"
                Grid.Column="2"
                Margin="12,0"
                VerticalAlignment="Center"
                FontSize="12"
                Foreground="#FF888888"
                Text="" />

              <!--  Row 2: Mode selection - aligned with Search button end  -->
              <StackPanel
                Grid.Row="1"
                Grid.Column="0"
                Grid.ColumnSpan="2"
                Margin="0,6,0,0"
                HorizontalAlignment="Stretch"
                Orientation="Horizontal">
                <RadioButton
                  x:Name="SearchModeText"
                  MinWidth="0"
                  Padding="4,0"
                  VerticalAlignment="Center"
                  VerticalContentAlignment="Center"
                  Content="Text"
                  FontSize="12"
                  GroupName="SearchMode"
                  IsChecked="True" />
                <RadioButton
                  x:Name="SearchModeHex"
                  MinWidth="0"
                  Margin="16,0,0,0"
                  Padding="4,0"
                  VerticalAlignment="Center"
                  VerticalContentAlignment="Center"
                  Content="Hex"
                  FontSize="12"
                  GroupName="SearchMode" />
                <CheckBox
                  x:Name="SearchCaseSensitive"
                  MinWidth="0"
                  Margin="16,0,0,0"
                  Padding="4,0"
                  VerticalAlignment="Center"
                  VerticalContentAlignment="Center"
                  Content="Match case"
                  FontSize="12" />
              </StackPanel>
            </Grid>
          </Border>

          <!--  Position indicator in hex  -->
          <Border
            x:Name="OffsetPanel"
            Grid.Row="2"
            Grid.Column="0"
            Grid.ColumnSpan="2"
            Padding="4,2"
            Background="#FF252526"
            CornerRadius="4">
            <TextBlock
              x:Name="PositionIndicator"
              FontFamily="Consolas"
              FontSize="10"
              Foreground="#FFCCCCCC"
              Text="Offset: 0x00000000" />
          </Border>
        </Grid>
      </Border>
    </Grid>

    <!--  Minimap Panel - match hex area background color  -->
    <Border
      Grid.Column="1"
      Margin="4,0,0,0"
      Background="#FF1E1E1E"
      BorderThickness="0"
      CornerRadius="4">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
          <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <TextBlock
          Grid.Row="0"
          Margin="0,4,0,4"
          HorizontalAlignment="Center"
          FontSize="10"
          Foreground="#FF888888"
          Text="Minimap" />

        <!--  Zoom controls with proper height  -->
        <Grid
          Grid.Row="1"
          Height="32"
          Margin="4,0,4,8"
          HorizontalAlignment="Stretch"
          VerticalAlignment="Center">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="20" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="24" />
          </Grid.ColumnDefinitions>
          <TextBlock
            Grid.Column="0"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            FontSize="9"
            Foreground="#FF666666"
            Text="1x" />
          <Slider
            x:Name="MinimapZoomSlider"
            Grid.Column="1"
            Height="32"
            Margin="4,0"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Center"
            IsThumbToolTipEnabled="False"
            Maximum="10"
            Minimum="1"
            ValueChanged="MinimapZoomSlider_ValueChanged"
            Value="1" />
          <TextBlock
            Grid.Column="2"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            FontSize="9"
            Foreground="#FF666666"
            Text="10x" />
        </Grid>

        <!--  Minimap container  -->
        <Border
          x:Name="MinimapContainer"
          Grid.Row="2"
          Margin="4"
          Background="#FF2D2D2D"
          CornerRadius="4"
          SizeChanged="MinimapContainer_SizeChanged">
          <ScrollViewer
            x:Name="MinimapScrollViewer"
            HorizontalScrollBarVisibility="Disabled"
            VerticalScrollBarVisibility="Auto">
            <Canvas
              x:Name="MinimapCanvas"
              Background="Transparent"
              PointerMoved="Minimap_PointerMoved"
              PointerPressed="Minimap_PointerPressed"
              PointerReleased="Minimap_PointerReleased">
              <Border
                x:Name="ViewportIndicator"
                Background="#40FFFFFF"
                BorderBrush="#FFFFFFFF"
                BorderThickness="2"
                CornerRadius="2"
                Visibility="Collapsed" />
            </Canvas>
          </ScrollViewer>
        </Border>
      </Grid>
    </Border>
  </Grid>
</UserControl>
