<?xml version="1.0" encoding="utf-8"?>

<UserControl
  x:Class="Xbox360MemoryCarver.SingleFileTab"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:controls="using:Microsoft.UI.Xaml.Controls"
  xmlns:ctk="using:CommunityToolkit.WinUI.Controls"
  xmlns:hexviewer="using:Xbox360MemoryCarver"
  xmlns:local="using:Xbox360MemoryCarver">

  <Grid Padding="16">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <!--  TOP: File Input Section - transparent for Mica  -->
    <Grid
      Grid.Row="0"
      Margin="0,0,0,8"
      RowSpacing="8">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
      </Grid.RowDefinitions>
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="Auto" />
        <ColumnDefinition Width="*" />
        <ColumnDefinition Width="Auto" />
      </Grid.ColumnDefinitions>

      <!--  Minidump Path  -->
      <TextBlock
        Grid.Row="0"
        Grid.Column="0"
        Margin="0,0,12,0"
        VerticalAlignment="Center"
        Text="Minidump Path" />
      <TextBox
        x:Name="MinidumpPathTextBox"
        Grid.Row="0"
        Grid.Column="1"
        Margin="0,0,8,0"
        AllowDrop="True"
        PlaceholderText="Select or enter a .dmp file path..."
        TextChanged="MinidumpPathTextBox_TextChanged" />
      <Button
        Grid.Row="0"
        Grid.Column="2"
        Click="OpenMinidumpButton_Click"
        Content="Browse..." />

      <!--  Output Directory  -->
      <TextBlock
        Grid.Row="1"
        Grid.Column="0"
        Margin="0,0,12,0"
        VerticalAlignment="Center"
        Text="Output Directory" />
      <TextBox
        x:Name="OutputPathTextBox"
        Grid.Row="1"
        Grid.Column="1"
        Margin="0,0,8,0"
        AllowDrop="True"
        PlaceholderText="Select or enter output directory..."
        TextChanged="OutputPathTextBox_TextChanged" />
      <Button
        Grid.Row="1"
        Grid.Column="2"
        Click="BrowseOutputButton_Click"
        Content="Browse..." />
    </Grid>

    <!--  Progress Bar  -->
    <ProgressBar
      x:Name="AnalysisProgressBar"
      Grid.Row="1"
      Margin="0,0,0,8"
      IsIndeterminate="True"
      Visibility="Collapsed" />

    <!--  MIDDLE: Memory Map and Discovered Files side-by-side - darker semi-transparent for Mica  -->
    <Grid Grid.Row="2">
      <Grid.ColumnDefinitions>
        <ColumnDefinition
          Width="*"
          MinWidth="500" />
        <ColumnDefinition Width="8" />
        <ColumnDefinition
          Width="*"
          MinWidth="400" />
      </Grid.ColumnDefinitions>

      <!--  Memory Map (Hex Viewer)  -->
      <Border
        Grid.Column="0"
        Padding="8"
        Background="#80202020"
        CornerRadius="8">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>

          <TextBlock
            Grid.Row="0"
            Margin="0,0,0,8"
            Style="{StaticResource SubtitleTextBlockStyle}"
            Text="Memory Map" />

          <hexviewer:HexViewerControl
            x:Name="HexViewer"
            Grid.Row="1" />
        </Grid>
      </Border>

      <!--  Splitter space  -->
      <controls:ContentPresenter Grid.Column="1" />

      <!--  Discovered Files Table  -->
      <Border
        Grid.Column="2"
        Padding="8"
        Background="#80202020"
        CornerRadius="8">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>

          <TextBlock
            Grid.Row="0"
            Margin="0,0,0,8"
            Style="{StaticResource SubtitleTextBlockStyle}"
            Text="Discovered Files" />

          <!--  Sticky column headers  -->
          <Grid
            Grid.Row="1"
            Margin="0,0,0,4"
            Padding="8,4"
            Background="{ThemeResource SystemControlBackgroundListLowBrush}"
            CornerRadius="4">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="90" />
              <ColumnDefinition Width="70" />
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="50" />
            </Grid.ColumnDefinitions>
            <Button
              Grid.Column="0"
              Padding="0"
              HorizontalAlignment="Left"
              Background="Transparent"
              BorderThickness="0"
              Click="SortByOffset_Click">
              <StackPanel
                Orientation="Horizontal"
                Spacing="4">
                <TextBlock
                  FontWeight="SemiBold"
                  Text="Offset" />
                <FontIcon
                  x:Name="OffsetSortIcon"
                  FontSize="10"
                  Glyph=""
                  Visibility="Collapsed" />
              </StackPanel>
            </Button>
            <Button
              Grid.Column="1"
              Padding="0"
              HorizontalAlignment="Left"
              Background="Transparent"
              BorderThickness="0"
              Click="SortByLength_Click">
              <StackPanel
                Orientation="Horizontal"
                Spacing="4">
                <TextBlock
                  FontWeight="SemiBold"
                  Text="Size" />
                <FontIcon
                  x:Name="LengthSortIcon"
                  FontSize="10"
                  Glyph=""
                  Visibility="Collapsed" />
              </StackPanel>
            </Button>
            <Button
              Grid.Column="2"
              Padding="0"
              HorizontalAlignment="Left"
              Background="Transparent"
              BorderThickness="0"
              Click="SortByType_Click">
              <StackPanel
                Orientation="Horizontal"
                Spacing="4">
                <TextBlock
                  FontWeight="SemiBold"
                  Text="Type" />
                <FontIcon
                  x:Name="TypeSortIcon"
                  FontSize="10"
                  Glyph=""
                  Visibility="Collapsed" />
              </StackPanel>
            </Button>
            <Button
              Grid.Column="3"
              Padding="0"
              HorizontalAlignment="Left"
              Background="Transparent"
              BorderThickness="0"
              Click="SortByFilename_Click">
              <StackPanel
                Orientation="Horizontal"
                Spacing="4">
                <TextBlock
                  FontWeight="SemiBold"
                  Text="Filename" />
                <FontIcon
                  x:Name="FilenameSortIcon"
                  FontSize="10"
                  Glyph=""
                  Visibility="Collapsed" />
              </StackPanel>
            </Button>
            <TextBlock
              Grid.Column="4"
              FontWeight="SemiBold"
              Text="" />
          </Grid>

          <!--  Scrollable file list  -->
          <ListView
            x:Name="ResultsListView"
            Grid.Row="2"
            RightTapped="ResultsListView_RightTapped"
            SelectionChanged="ResultsListView_SelectionChanged"
            SelectionMode="Single">
            <ListView.ContextFlyout>
              <MenuFlyout x:Name="FileListContextMenu">
                <MenuFlyoutItem
                  x:Name="GoToStartMenuItem"
                  Click="GoToStart_Click"
                  Text="Go to Start">
                  <MenuFlyoutItem.Icon>
                    <FontIcon Glyph="&#xE76B;" />
                  </MenuFlyoutItem.Icon>
                </MenuFlyoutItem>
                <MenuFlyoutItem
                  x:Name="GoToEndMenuItem"
                  Click="GoToEnd_Click"
                  Text="Go to End">
                  <MenuFlyoutItem.Icon>
                    <FontIcon Glyph="&#xE76C;" />
                  </MenuFlyoutItem.Icon>
                </MenuFlyoutItem>
                <MenuFlyoutSeparator />
                <MenuFlyoutItem
                  x:Name="CopyOffsetMenuItem"
                  Click="CopyOffset_Click"
                  Text="Copy Offset">
                  <MenuFlyoutItem.Icon>
                    <FontIcon Glyph="&#xE8C8;" />
                  </MenuFlyoutItem.Icon>
                </MenuFlyoutItem>
                <MenuFlyoutItem
                  x:Name="CopyFilenameMenuItem"
                  Click="CopyFilename_Click"
                  Text="Copy Filename">
                  <MenuFlyoutItem.Icon>
                    <FontIcon Glyph="&#xE8C8;" />
                  </MenuFlyoutItem.Icon>
                </MenuFlyoutItem>
              </MenuFlyout>
            </ListView.ContextFlyout>
            <ListView.ItemTemplate>
              <DataTemplate x:DataType="local:CarvedFileEntry">
                <Grid Padding="8,4">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="90" />
                    <ColumnDefinition Width="70" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="50" />
                  </Grid.ColumnDefinitions>
                  <TextBlock
                    Grid.Column="0"
                    FontFamily="Consolas"
                    FontSize="11"
                    Text="{x:Bind OffsetHex}" />
                  <TextBlock
                    Grid.Column="1"
                    FontSize="11"
                    Text="{x:Bind LengthFormatted}" />
                  <TextBlock
                    Grid.Column="2"
                    FontSize="11"
                    Text="{x:Bind FileType}"
                    TextTrimming="CharacterEllipsis"
                    ToolTipService.ToolTip="{x:Bind FileType}" />
                  <TextBlock
                    Grid.Column="3"
                    FontSize="11"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    Text="{x:Bind FileNameDisplay}"
                    TextTrimming="CharacterEllipsis"
                    ToolTipService.ToolTip="{x:Bind FileNameDisplay}" />
                  <FontIcon
                    Grid.Column="4"
                    HorizontalAlignment="Center"
                    FontSize="12"
                    Foreground="{x:Bind ExtractedColor, Mode=OneWay}"
                    Glyph="{x:Bind ExtractedGlyph, Mode=OneWay}" />
                </Grid>
              </DataTemplate>
            </ListView.ItemTemplate>
          </ListView>
        </Grid>
      </Border>
    </Grid>

    <!--  BOTTOM: File Types, Options, and Extract Button - transparent for Mica  -->
    <Grid
      Grid.Row="3"
      Margin="0,8,0,0">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
      </Grid.RowDefinitions>

      <!--  File Type Filters  -->
      <Expander
        Grid.Row="0"
        Margin="0,0,0,8"
        HorizontalAlignment="Stretch"
        HorizontalContentAlignment="Stretch"
        Header="File Types to Extract">
        <ctk:WrapPanel
          x:Name="FileTypeCheckboxPanel"
          HorizontalSpacing="16"
          VerticalSpacing="8">
          <!--  Checkboxes will be generated dynamically  -->
        </ctk:WrapPanel>
      </Expander>

      <!--  Options and Extract Button  -->
      <Grid Grid.Row="1">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <StackPanel
          Grid.Column="0"
          VerticalAlignment="Center"
          Orientation="Horizontal"
          Spacing="24">
          <!--  Texture Options  -->
          <StackPanel Orientation="Horizontal"
                      Spacing="8">
            <CheckBox
              x:Name="ConvertDdxCheckBox"
              MinWidth="0"
              Content="Convert DDX to DDS"
              IsChecked="True" />
            <CheckBox
              x:Name="SaveAtlasCheckBox"
              Margin="16,0,0,0"
              Content="Save Atlas Files" />
          </StackPanel>

          <Border Width="1"
                  Height="20"
                  Background="{ThemeResource DividerStrokeColorDefaultBrush}" />

          <!--  Output Options  -->
          <StackPanel Orientation="Horizontal"
                      Spacing="8">
            <CheckBox
              x:Name="VerboseCheckBox"
              MinWidth="0"
              Content="Verbose"
              ToolTipService.ToolTip="Output detailed progress to the terminal (when launched from command line)" />
          </StackPanel>
        </StackPanel>

        <StackPanel
          Grid.Column="1"
          Orientation="Horizontal"
          Spacing="8">
          <Button
            x:Name="AnalyzeButton"
            MinWidth="100"
            Click="AnalyzeButton_Click"
            Content="Analyze"
            IsEnabled="False"
            Style="{StaticResource AccentButtonStyle}" />
          <Button
            x:Name="ExtractButton"
            MinWidth="120"
            Click="ExtractButton_Click"
            Content="Extract Files"
            IsEnabled="False"
            Style="{StaticResource AccentButtonStyle}" />
        </StackPanel>
      </Grid>
    </Grid>
  </Grid>
</UserControl>
